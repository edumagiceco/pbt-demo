<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìŠµ ìë£Œ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .container { max-width: 800px; }
        .card { margin-bottom: 20px; }
        #materialsList { margin-top: 30px; }
        .material-item { 
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .material-actions { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">PBT LMS - í•™ìŠµ ìë£Œ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ë¡œê·¸ì¸ í¼ -->
        <div class="card" id="loginCard">
            <div class="card-header">ë¡œê·¸ì¸</div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">ì´ë©”ì¼</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
                </form>
            </div>
        </div>
        
        <!-- ë¬¸ì œ ëª©ë¡ -->
        <div class="card d-none" id="problemCard">
            <div class="card-header">ë¬¸ì œ ì„ íƒ</div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="problemSelect" class="form-label">ë¬¸ì œ ì„ íƒ</label>
                    <select class="form-select" id="problemSelect">
                        <option value="">ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="card d-none" id="uploadCard">
            <div class="card-header">í•™ìŠµ ìë£Œ ì—…ë¡œë“œ</div>
            <div class="card-body">
                <form id="uploadForm">
                    <input type="hidden" id="selectedProblemId" name="problemId">
                    <div class="mb-3">
                        <label for="title" class="form-label">ì œëª©</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">ìë£Œ ìœ í˜•</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="document">ë¬¸ì„œ</option>
                            <option value="video">ë¹„ë””ì˜¤</option>
                            <option value="link">ë§í¬</option>
                            <option value="code">ì½”ë“œ</option>
                        </select>
                    </div>
                    <div class="mb-3" id="fileInputGroup">
                        <label for="file" class="form-label">íŒŒì¼</label>
                        <input type="file" class="form-control" id="file" name="file">
                    </div>
                    <div class="mb-3 d-none" id="urlInputGroup">
                        <label for="url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="url" name="url">
                    </div>
                    <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ</button>
                </form>
            </div>
        </div>
        
        <!-- ìë£Œ ëª©ë¡ -->
        <div id="materialsList" class="d-none">
            <h3>í•™ìŠµ ìë£Œ ëª©ë¡</h3>
            <div id="materialsContainer"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let token = localStorage.getItem('token');
        let currentProblemId = null;
        
        // DOM ìš”ì†Œ
        const loginCard = document.getElementById('loginCard');
        const problemCard = document.getElementById('problemCard');
        const uploadCard = document.getElementById('uploadCard');
        const materialsList = document.getElementById('materialsList');
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('uploadForm').addEventListener('submit', handleUpload);
        document.getElementById('problemSelect').addEventListener('change', handleProblemSelect);
        document.getElementById('type').addEventListener('change', handleTypeChange);
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²´í¬
        window.addEventListener('DOMContentLoaded', () => {
            if (token) {
                loginCard.classList.add('d-none');
                problemCard.classList.remove('d-none');
                fetchProblems();
            }
        });
        
        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    
                    loginCard.classList.add('d-none');
                    problemCard.classList.remove('d-none');
                    
                    fetchProblems();
                    
                    alert('ë¡œê·¸ì¸ ì„±ê³µ!');
                } else {
                    alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ë¬¸ì œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchProblems() {
            try {
                const response = await fetch('/api/problems', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const problemSelect = document.getElementById('problemSelect');
                    
                    // Clear existing options
                    problemSelect.innerHTML = '<option value="">ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    // Add problems to select
                    data.data.problems.forEach(problem => {
                        const option = document.createElement('option');
                        option.value = problem.id;
                        option.textContent = problem.title;
                        problemSelect.appendChild(option);
                    });
                } else {
                    alert('ë¬¸ì œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                console.error('ë¬¸ì œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                alert('ë¬¸ì œ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ë¬¸ì œ ì„ íƒ ì²˜ë¦¬
        function handleProblemSelect(e) {
            const problemId = e.target.value;
            
            if (problemId) {
                currentProblemId = problemId;
                document.getElementById('selectedProblemId').value = problemId;
                
                uploadCard.classList.remove('d-none');
                materialsList.classList.remove('d-none');
                
                fetchMaterials(problemId);
            } else {
                uploadCard.classList.add('d-none');
                materialsList.classList.add('d-none');
                currentProblemId = null;
            }
        }
        
        // ìë£Œ ìœ í˜• ë³€ê²½ ì²˜ë¦¬
        function handleTypeChange(e) {
            const type = e.target.value;
            const fileInputGroup = document.getElementById('fileInputGroup');
            const urlInputGroup = document.getElementById('urlInputGroup');
            
            if (type === 'link') {
                fileInputGroup.classList.add('d-none');
                urlInputGroup.classList.remove('d-none');
                document.getElementById('url').required = true;
                document.getElementById('file').required = false;
            } else {
                fileInputGroup.classList.remove('d-none');
                urlInputGroup.classList.add('d-none');
                document.getElementById('url').required = false;
                document.getElementById('file').required = type === 'document' || type === 'video';
            }
        }
        
        // í•™ìŠµ ìë£Œ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleUpload(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/materials', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('í•™ìŠµ ìë£Œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
                    form.reset();
                    fetchMaterials(currentProblemId);
                } else {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // í•™ìŠµ ìë£Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchMaterials(problemId) {
            try {
                const response = await fetch(`/api/materials/problem/${problemId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const materialsContainer = document.getElementById('materialsContainer');
                    
                    // Clear existing materials
                    materialsContainer.innerHTML = '';
                    
                    // Add materials to list
                    if (data.data.length === 0) {
                        materialsContainer.innerHTML = '<p>ë“±ë¡ëœ í•™ìŠµ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                        data.data.forEach(material => {
                            const materialItem = document.createElement('div');
                            materialItem.className = 'material-item';
                            
                            const materialInfo = document.createElement('div');
                            materialInfo.className = 'material-info';
                            
                            // ìë£Œ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜
                            let typeIcon = '';
                            switch(material.type) {
                                case 'document': typeIcon = 'ğŸ“„'; break;
                                case 'video': typeIcon = 'ğŸ¬'; break;
                                case 'link': typeIcon = 'ğŸ”—'; break;
                                case 'code': typeIcon = 'ğŸ’»'; break;
                            }
                            
                            materialInfo.innerHTML = `
                                <strong>${typeIcon} ${material.title}</strong>
                                <div class="text-muted small">
                                    ì˜¬ë¦°ì´: ${material.uploader?.fullName || 'ì•Œ ìˆ˜ ì—†ìŒ'} | 
                                    ë‚ ì§œ: ${new Date(material.createdAt).toLocaleDateString()}
                                </div>
                            `;
                            
                            const materialActions = document.createElement('div');
                            materialActions.className = 'material-actions';
                            
                            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (íŒŒì¼ì´ ìˆëŠ” ê²½ìš°ë§Œ)
                            if (material.filePath) {
                                const downloadBtn = document.createElement('button');
                                downloadBtn.className = 'btn btn-sm btn-primary';
                                downloadBtn.textContent = 'ë‹¤ìš´ë¡œë“œ';
                                downloadBtn.addEventListener('click', () => downloadMaterial(material.id));
                                materialActions.appendChild(downloadBtn);
                            }
                            
                            // URL ë§í¬ (ë§í¬ íƒ€ì…ì¸ ê²½ìš°ë§Œ)
                            if (material.type === 'link' && material.url) {
                                const linkBtn = document.createElement('a');
                                linkBtn.className = 'btn btn-sm btn-success';
                                linkBtn.href = material.url;
                                linkBtn.target = '_blank';
                                linkBtn.textContent = 'ë§í¬ ì—´ê¸°';
                                materialActions.appendChild(linkBtn);
                            }
                            
                            // ì‚­ì œ ë²„íŠ¼
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn btn-sm btn-danger';
                            deleteBtn.textContent = 'ì‚­ì œ';
                            deleteBtn.addEventListener('click', () => deleteMaterial(material.id));
                            materialActions.appendChild(deleteBtn);
                            
                            materialItem.appendChild(materialInfo);
                            materialItem.appendChild(materialActions);
                            materialsContainer.appendChild(materialItem);
                        });
                    }
                } else {
                    alert('í•™ìŠµ ìë£Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                console.error('í•™ìŠµ ìë£Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                alert('í•™ìŠµ ìë£Œ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // í•™ìŠµ ìë£Œ ë‹¤ìš´ë¡œë“œ
        function downloadMaterial(materialId) {
            window.open(`/api/materials/download/${materialId}`);
        }
        
        // í•™ìŠµ ìë£Œ ì‚­ì œ
        async function deleteMaterial(materialId) {
            if (!confirm('ì •ë§ë¡œ ì´ í•™ìŠµ ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/materials/${materialId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('í•™ìŠµ ìë£Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    fetchMaterials(currentProblemId);
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }
    </script>
</body>
</html>