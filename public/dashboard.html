<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 인재 커리어 플랫폼 PBT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: #4a5568;
        }
        
        .navbar .logo img {
            height: 40px;
            width: auto;
        }
        
        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .navbar .user-name {
            color: #4a5568;
            font-weight: 500;
        }
        
        .navbar .logout-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .navbar .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .welcome-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
        }
        
        .welcome-section h2 {
            color: #4a5568;
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .welcome-section p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card h3 {
            color: #4a5568;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .dashboard-card p {
            color: #718096;
            margin-bottom: 1rem;
        }
        
        .dashboard-card .btn {
            display: inline-block;
            padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .dashboard-card .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="/assets/images/pbt-logo.png" alt="PBT Logo">
            <span>AI 인재 커리어 플랫폼 PBT</span>
        </div>
        <div class="user-info">
            <span class="user-name" id="userName">사용자님</span>
            <button class="logout-btn" onclick="logout()">로그아웃</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="welcome-section">
            <h2>안녕하세요, <span id="welcomeName">사용자</span>님! 👋</h2>
            <p>PBT LMS에 오신 것을 환영합니다. 오늘도 문제 해결 능력을 기르며 학습해보세요.</p>
        </div>
        
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="courseCount">-</div>
                <div class="stat-label">참여 중인 과정</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="problemCount">-</div>
                <div class="stat-label">해결한 문제</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="progressPercent">-</div>
                <div class="stat-label">전체 진도율</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>📚 내 과정</h3>
                <p>참여 중인 과정들을 확인하고 학습을 계속하세요.</p>
                <a href="/courses.html" class="btn">과정 보기</a>
            </div>
            
            <div class="dashboard-card">
                <h3>🧩 문제 풀이</h3>
                <p>다양한 문제들을 풀어보며 실무 역량을 키워보세요.</p>
                <a href="/problems.html" class="btn">문제 풀기</a>
            </div>
            
            <div class="dashboard-card">
                <h3>📊 학습 진도</h3>
                <p>내 학습 현황과 진도를 상세히 확인하세요.</p>
                <a href="/progress.html" class="btn">진도 확인</a>
            </div>
            
            <div class="dashboard-card">
                <h3>💬 토론 게시판</h3>
                <p>다른 학습자들과 의견을 나누고 토론하세요.</p>
                <a href="/discussions.html" class="btn">토론 참여</a>
            </div>
            
            <div class="dashboard-card">
                <h3>📝 과제 제출</h3>
                <p>과제를 제출하고 피드백을 받아보세요.</p>
                <a href="/assignments.html" class="btn">과제 보기</a>
            </div>
            
            <div class="dashboard-card">
                <h3>🎯 만다라트</h3>
                <p>목표를 체계적으로 관리하고 달성해보세요.</p>
                <a href="/mandarts.html" class="btn">만다라트 보기</a>
            </div>
            
            <div class="dashboard-card">
                <h3>🧑‍🏫 강사 AI</h3>
                <p>강의 자료를 기반으로 개념을 설명하고 학습을 도와드립니다.</p>
                <a href="/instructor-ai.html" class="btn">강사 AI 시작</a>
            </div>
            
            <div class="dashboard-card">
                <h3>🤖 AI 멘토</h3>
                <p>나만의 AI 멘토를 만들어 1:1 맞춤형 학습을 받아보세요.</p>
                <a href="/mentors.html" class="btn">멘토 관리</a>
            </div>
            

            
            <div class="dashboard-card">
                <h3>👤 프로필 설정</h3>
                <p>내 프로필과 계정 설정을 관리하세요.</p>
                <a href="/profile.html" class="btn">설정 변경</a>
            </div>
            
            <div id="adminCard" class="dashboard-card" style="display: none; background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); color: white;">
                <h3>🛡️ 관리자 대시보드</h3>
                <p>시스템 관리 및 사용자 관리 기능에 접근하세요.</p>
                <a href="/admin-dashboard.html" class="btn" style="background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white;">관리자 모드</a>
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 시 사용자 정보 확인
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');
            
            if (!token) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login.html';
                return;
            }
            
            try {
                // 토큰 유효성 검사
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('토큰이 유효하지 않습니다.');
                }
                
                const result = await response.json();
                
                if (result.success && result.user) {
                    // 사용자 정보 표시
                    const user = result.user;
                    document.getElementById('userName').textContent = user.fullName || user.username;
                    document.getElementById('welcomeName').textContent = user.fullName || user.username;
                    
                    // 관리자 카드 표시 (관리자인 경우에만)
                    if (user.userType === 'admin') {
                        document.getElementById('adminCard').style.display = 'block';
                    }
                    
                    // 사용자 정보 업데이트
                    localStorage.setItem('userInfo', JSON.stringify(user));
                    
                    // 통계 정보 로드
                    loadUserStats(user.id);
                } else {
                    throw new Error('사용자 정보를 가져올 수 없습니다.');
                }
                
            } catch (error) {
                console.error('인증 오류:', error);
                
                // 데모 환경을 위한 fallback: localStorage에서 사용자 정보 확인
                const savedUserInfo = localStorage.getItem('userInfo');
                if (savedUserInfo) {
                    try {
                        const user = JSON.parse(savedUserInfo);
                        document.getElementById('userName').textContent = user.fullName || user.username || '사용자';
                        document.getElementById('welcomeName').textContent = user.fullName || user.username || '사용자';
                        
                        // 관리자 카드 표시 (관리자인 경우에만)
                        if (user.userType === 'admin') {
                            document.getElementById('adminCard').style.display = 'block';
                        }
                        
                        // 사용자 유형별 데모 통계 데이터 표시
                        if (user.userType === 'student') {
                            document.getElementById('courseCount').textContent = '4';
                            document.getElementById('problemCount').textContent = '27';
                            document.getElementById('progressPercent').textContent = '62%';
                        } else if (user.userType === 'instructor') {
                            document.getElementById('courseCount').textContent = '2';
                            document.getElementById('problemCount').textContent = '8';
                            document.getElementById('progressPercent').textContent = '100%';
                        } else if (user.userType === 'admin') {
                            document.getElementById('courseCount').textContent = '8';
                            document.getElementById('problemCount').textContent = '0';
                            document.getElementById('progressPercent').textContent = '100%';
                        } else {
                            document.getElementById('courseCount').textContent = '3';
                            document.getElementById('problemCount').textContent = '15';
                            document.getElementById('progressPercent').textContent = '68%';
                        }
                        
                        return; // 성공적으로 fallback 처리됨
                    } catch (parseError) {
                        console.error('사용자 정보 파싱 오류:', parseError);
                    }
                }
                
                // 완전 실패 시 로그인 페이지로 이동
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                window.location.href = '/login.html';
            }
        });
        
        // 사용자 통계 정보 로드
        async function loadUserStats(userId) {
            try {
                const token = localStorage.getItem('authToken');
                
                // 각각의 통계를 병렬로 로드
                const [coursesRes, problemsRes, progressRes] = await Promise.all([
                    fetch(`/api/users/${userId}/courses`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`/api/users/${userId}/problems/solved`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`/api/users/${userId}/progress`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                // 기본값 설정
                let courseCount = 0;
                let problemCount = 0;
                let progressPercent = 0;
                
                if (coursesRes.ok) {
                    const coursesData = await coursesRes.json();
                    courseCount = coursesData.data ? coursesData.data.length : 0;
                }
                
                if (problemsRes.ok) {
                    const problemsData = await problemsRes.json();
                    problemCount = problemsData.count || 0;
                }
                
                if (progressRes.ok) {
                    const progressData = await progressRes.json();
                    progressPercent = Math.round(progressData.averageProgress || 0);
                }
                
                // UI 업데이트
                document.getElementById('courseCount').textContent = courseCount;
                document.getElementById('problemCount').textContent = problemCount;
                document.getElementById('progressPercent').textContent = `${progressPercent}%`;
                
            } catch (error) {
                console.error('통계 로드 오류:', error);
                // 오류 발생 시 기본값 유지
                document.getElementById('courseCount').textContent = '0';
                document.getElementById('problemCount').textContent = '0';
                document.getElementById('progressPercent').textContent = '0%';
            }
        }
        
        // 로그아웃 함수
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = '/';
            }
        }
    </script>
    
    <!-- PBT LMS 챗봇 -->
    <script src="/js/chatbot.js"></script>
</body>
</html>