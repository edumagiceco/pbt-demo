<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코드 제출 및 평가 테스트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <style>
        body { padding: 20px; }
        .container { max-width: 1000px; }
        .card { margin-bottom: 20px; }
        .CodeMirror { 
            height: auto;
            min-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .output-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-case {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-case.passed {
            border-left: 5px solid #198754;
        }
        .test-case.failed {
            border-left: 5px solid #dc3545;
        }
        .test-details {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .solutions-list {
            margin-top: 20px;
        }
        .solution-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">PBT LMS - 코드 제출 및 평가 테스트</h1>
        
        <!-- 로그인 폼 -->
        <div class="card" id="loginCard">
            <div class="card-header">로그인</div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">비밀번호</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">로그인</button>
                </form>
            </div>
        </div>
        
        <!-- 문제 선택 -->
        <div class="card d-none" id="problemCard">
            <div class="card-header">문제 선택</div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="problemSelect" class="form-label">문제 선택</label>
                    <select class="form-select" id="problemSelect">
                        <option value="">문제를 선택하세요</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 문제 상세 정보 -->
        <div class="card d-none" id="problemDetailCard">
            <div class="card-header">문제 상세</div>
            <div class="card-body">
                <h3 id="problemTitle"></h3>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>난이도:</strong> <span id="problemDifficulty"></span></p>
                        <p><strong>카테고리:</strong> <span id="problemCategory"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>최대 점수:</strong> <span id="problemMaxScore"></span></p>
                        <p><strong>제한 시간:</strong> <span id="problemTimeLimit"></span> 분</p>
                    </div>
                </div>
                <div class="mt-3">
                    <h5>문제 설명</h5>
                    <div id="problemDescription"></div>
                </div>
            </div>
        </div>
        
        <!-- 코드 제출 -->
        <div class="card d-none" id="solutionCard">
            <div class="card-header">코드 제출</div>
            <div class="card-body">
                <form id="solutionForm">
                    <input type="hidden" id="selectedProblemId" name="problemId">
                    <div class="mb-3">
                        <label for="language" class="form-label">프로그래밍 언어</label>
                        <select class="form-select" id="language" name="language" required>
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="code" class="form-label">코드</label>
                        <textarea class="form-control" id="code" name="code" required></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="input" class="form-label">입력값 (테스트용)</label>
                                <textarea class="form-control" id="input" rows="3"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">출력 결과</label>
                                <div id="output" class="output-container"></div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <button type="button" id="runBtn" class="btn btn-secondary me-2">코드 실행</button>
                            <button type="submit" id="submitBtn" class="btn btn-primary">제출</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 평가 결과 -->
        <div class="card d-none" id="evaluationCard">
            <div class="card-header">평가 결과</div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary">
                            <div class="card-body text-center">
                                <h3 id="totalScore">0</h3>
                                <p class="mb-0">총점</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success">
                            <div class="card-body text-center">
                                <h3 id="passedTests">0</h3>
                                <p class="mb-0">통과 테스트</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-danger">
                            <div class="card-body text-center">
                                <h3 id="failedTests">0</h3>
                                <p class="mb-0">실패 테스트</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info">
                            <div class="card-body text-center">
                                <h3 id="executionTime">0ms</h3>
                                <p class="mb-0">실행 시간</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h5>테스트 결과</h5>
                <div id="testResults"></div>
                
                <div class="mt-3" id="instructorFeedback">
                    <h5>강사 피드백</h5>
                    <div id="feedback" class="p-3 bg-light rounded"></div>
                </div>
            </div>
        </div>
        
        <!-- 내 제출 목록 -->
        <div class="card d-none" id="solutionsCard">
            <div class="card-header">내 제출 목록</div>
            <div class="card-body">
                <div id="solutionsList"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>
    
    <script>
        // 전역 변수
        let token = localStorage.getItem('token');
        let currentProblemId = null;
        let codeMirror = null;
        let currentSolutionId = null;
        
        // DOM 요소
        const loginCard = document.getElementById('loginCard');
        const problemCard = document.getElementById('problemCard');
        const problemDetailCard = document.getElementById('problemDetailCard');
        const solutionCard = document.getElementById('solutionCard');
        const evaluationCard = document.getElementById('evaluationCard');
        const solutionsCard = document.getElementById('solutionsCard');
        
        // 이벤트 리스너
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('problemSelect').addEventListener('change', handleProblemSelect);
        document.getElementById('solutionForm').addEventListener('submit', handleSolutionSubmit);
        document.getElementById('runBtn').addEventListener('click', handleRunCode);
        document.getElementById('language').addEventListener('change', updateEditorMode);
        
        // 페이지 로드 시 초기화
        window.addEventListener('DOMContentLoaded', () => {
            // CodeMirror 초기화
            codeMirror = CodeMirror.fromTextArea(document.getElementById('code'), {
                lineNumbers: true,
                mode: 'javascript',
                theme: 'dracula',
                indentUnit: 4,
                smartIndent: true,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: true,
                extraKeys: {
                    'Tab': function(cm) {
                        cm.replaceSelection('    ', 'end');
                    }
                }
            });
            
            if (token) {
                loginCard.classList.add('d-none');
                problemCard.classList.remove('d-none');
                fetchProblems();
            }
        });
        
        // 로그인 처리
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    
                    loginCard.classList.add('d-none');
                    problemCard.classList.remove('d-none');
                    
                    fetchProblems();
                    
                    alert('로그인 성공!');
                } else {
                    alert('로그인 실패: ' + data.message);
                }
            } catch (error) {
                console.error('로그인 오류:', error);
                alert('로그인 중 오류가 발생했습니다');
            }
        }
        
        // 문제 목록 가져오기
        async function fetchProblems() {
            try {
                const response = await fetch('/api/problems', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const problemSelect = document.getElementById('problemSelect');
                    
                    // Clear existing options
                    problemSelect.innerHTML = '<option value="">문제를 선택하세요</option>';
                    
                    // Add problems to select
                    data.data.problems.forEach(problem => {
                        const option = document.createElement('option');
                        option.value = problem.id;
                        option.textContent = problem.title;
                        problemSelect.appendChild(option);
                    });
                } else {
                    alert('문제 목록 가져오기 실패: ' + data.message);
                }
            } catch (error) {
                console.error('문제 목록 가져오기 오류:', error);
                alert('문제 목록을 가져오는 중 오류가 발생했습니다');
            }
        }
        
        // 문제 선택 처리
        async function handleProblemSelect(e) {
            const problemId = e.target.value;
            
            if (!problemId) {
                problemDetailCard.classList.add('d-none');
                solutionCard.classList.add('d-none');
                evaluationCard.classList.add('d-none');
                solutionsCard.classList.add('d-none');
                currentProblemId = null;
                return;
            }
            
            currentProblemId = problemId;
            document.getElementById('selectedProblemId').value = problemId;
            
            try {
                // 문제 상세 정보 가져오기
                const response = await fetch(`/api/problems/${problemId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 문제 정보 표시
                    const problem = data.data;
                    document.getElementById('problemTitle').textContent = problem.title;
                    document.getElementById('problemDifficulty').textContent = problem.difficulty;
                    document.getElementById('problemCategory').textContent = problem.category || '분류 없음';
                    document.getElementById('problemMaxScore').textContent = problem.maxScore || 100;
                    document.getElementById('problemTimeLimit').textContent = problem.timeLimit || '제한 없음';
                    document.getElementById('problemDescription').innerHTML = problem.description;
                    
                    // 카드 표시
                    problemDetailCard.classList.remove('d-none');
                    solutionCard.classList.remove('d-none');
                    solutionsCard.classList.remove('d-none');
                    
                    // 제출 목록 가져오기
                    fetchSolutions(problemId);
                    
                    // 기본 코드 설정 (언어별)
                    setDefaultCode(document.getElementById('language').value);
                    
                } else {
                    alert('문제 정보 가져오기 실패: ' + data.message);
                }
            } catch (error) {
                console.error('문제 정보 가져오기 오류:', error);
                alert('문제 정보를 가져오는 중 오류가 발생했습니다');
            }
        }
        
        // 언어별 기본 코드 설정
        function setDefaultCode(language) {
            let defaultCode = '';
            
            switch(language) {
                case 'javascript':
                    defaultCode = `// JavaScript 코드를 작성하세요
function solution(input) {
    // 여기에 코드를 작성하세요
    return input;
}

// 입력값 처리 예시
const input = process.argv[2];
console.log(solution(input));`;
                    break;
                case 'python':
                    defaultCode = `# Python 코드를 작성하세요
def solution(input):
    # 여기에 코드를 작성하세요
    return input

# 입력값 처리 예시
if __name__ == "__main__":
    import sys
    input = sys.stdin.read()
    print(solution(input))`;
                    break;
                case 'java':
                    defaultCode = `// Java 코드를 작성하세요
import java.util.*;

public class Main {
    public static void main(String[] args) {
        Scanner scanner = new Scanner(System.in);
        String input = scanner.nextLine();
        System.out.println(solution(input));
        scanner.close();
    }
    
    public static String solution(String input) {
        // 여기에 코드를 작성하세요
        return input;
    }
}`;
                    break;
                case 'cpp':
                    defaultCode = `// C++ 코드를 작성하세요
#include <iostream>
#include <string>
using namespace std;

string solution(string input) {
    // 여기에 코드를 작성하세요
    return input;
}

int main() {
    string input;
    getline(cin, input);
    cout << solution(input) << endl;
    return 0;
}`;
                    break;
            }
            
            codeMirror.setValue(defaultCode);
        }
        
        // 코드 에디터 모드 업데이트
        function updateEditorMode() {
            const language = document.getElementById('language').value;
            let mode;
            
            switch(language) {
                case 'javascript':
                    mode = 'javascript';
                    break;
                case 'python':
                    mode = 'python';
                    break;
                case 'java':
                    mode = 'text/x-java';
                    break;
                case 'cpp':
                    mode = 'text/x-c++src';
                    break;
                default:
                    mode = 'javascript';
            }
            
            codeMirror.setOption('mode', mode);
            setDefaultCode(language);
        }
        
        // 코드 실행 처리
        async function handleRunCode() {
            const code = codeMirror.getValue();
            const language = document.getElementById('language').value;
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            
            if (!code) {
                alert('코드를 입력해주세요.');
                return;
            }
            
            output.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>실행 중...</p></div>';
            
            try {
                const response = await fetch('/api/solutions/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ code, language, input })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    
                    let outputContent = '';
                    
                    if (result.success) {
                        outputContent = `<div class="alert alert-success mb-2">실행 성공 (${result.executionTime}ms)</div>`;
                        outputContent += `<pre>${result.output}</pre>`;
                    } else {
                        outputContent = `<div class="alert alert-danger mb-2">실행 실패 (${result.status})</div>`;
                        outputContent += `<pre class="text-danger">${result.output}</pre>`;
                    }
                    
                    output.innerHTML = outputContent;
                } else {
                    output.innerHTML = `<div class="alert alert-danger">오류: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('코드 실행 오류:', error);
                output.innerHTML = '<div class="alert alert-danger">서버 오류가 발생했습니다</div>';
            }
        }
        
        // 솔루션 제출 처리
        async function handleSolutionSubmit(e) {
            e.preventDefault();
            
            const problemId = currentProblemId;
            const code = codeMirror.getValue();
            const language = document.getElementById('language').value;
            
            if (!code) {
                alert('코드를 입력해주세요.');
                return;
            }
            
            try {
                // 솔루션 제출
                const response = await fetch('/api/solutions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ problemId, code, language })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('솔루션이 제출되었습니다.');
                    
                    // 제출된 솔루션 ID 저장
                    currentSolutionId = data.data.id;
                    
                    // 자동 평가 실행
                    await autoEvaluateSolution(currentSolutionId);
                    
                    // 제출 목록 새로고침
                    fetchSolutions(problemId);
                } else {
                    alert('제출 실패: ' + data.message);
                }
            } catch (error) {
                console.error('솔루션 제출 오류:', error);
                alert('솔루션 제출 중 오류가 발생했습니다');
            }
        }
        
        // 솔루션 자동 평가
        async function autoEvaluateSolution(solutionId) {
            try {
                const response = await fetch(`/api/solutions/${solutionId}/auto-evaluate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 평가 결과 표시
                    displayEvaluationResult(data.data.evaluationResult);
                    
                    // 평가 카드 표시
                    evaluationCard.classList.remove('d-none');
                } else {
                    alert('자동 평가 실패: ' + data.message);
                }
            } catch (error) {
                console.error('자동 평가 오류:', error);
                alert('자동 평가 중 오류가 발생했습니다');
            }
        }
        
        // 평가 결과 표시
        function displayEvaluationResult(result) {
            document.getElementById('totalScore').textContent = result.percentageScore + '%';
            document.getElementById('passedTests').textContent = result.passed;
            document.getElementById('failedTests').textContent = result.failed;
            document.getElementById('executionTime').textContent = result.executionTime + 'ms';
            
            const testResultsContainer = document.getElementById('testResults');
            testResultsContainer.innerHTML = '';
            
            // 테스트 결과 표시
            result.testResults.forEach((test, index) => {
                const testCase = document.createElement('div');
                testCase.className = `test-case ${test.passed ? 'passed' : 'failed'}`;
                
                let testContent = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>테스트 ${index + 1}${test.description ? ': ' + test.description : ''}</strong>
                            <div class="test-details">
                                ${!test.isHidden ? `
                                <div><strong>입력:</strong> <pre class="mb-1">${test.input}</pre></div>
                                <div><strong>기대 출력:</strong> <pre class="mb-1">${test.expectedOutput}</pre></div>
                                <div><strong>실제 출력:</strong> <pre class="mb-1">${test.actualOutput}</pre></div>
                                ` : '<div>[숨겨진 테스트 케이스]</div>'}
                            </div>
                        </div>
                        <div class="ms-3 text-nowrap">
                            <span class="badge ${test.passed ? 'bg-success' : 'bg-danger'}">${test.passed ? '통과' : '실패'}</span>
                            <div class="mt-1 text-muted small">${test.score}/${test.points}점</div>
                            <div class="mt-1 text-muted small">${test.executionTime}ms</div>
                        </div>
                    </div>
                `;
                
                testCase.innerHTML = testContent;
                testResultsContainer.appendChild(testCase);
            });
            
            // 강사 피드백 섹션 숨기기 (아직 없음)
            document.getElementById('instructorFeedback').classList.add('d-none');
        }
        
        // 솔루션 목록 가져오기
        async function fetchSolutions(problemId) {
            try {
                const response = await fetch(`/api/solutions?problemId=${problemId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const solutionsList = document.getElementById('solutionsList');
                    solutionsList.innerHTML = '';
                    
                    if (data.data.solutions.length === 0) {
                        solutionsList.innerHTML = '<p>제출한 솔루션이 없습니다.</p>';
                    } else {
                        // 솔루션 목록 표시
                        data.data.solutions.forEach(solution => {
                            const solutionItem = document.createElement('div');
                            solutionItem.className = 'solution-item';
                            
                            // 상태에 따른 배지 색상
                            let statusBadge;
                            switch(solution.status) {
                                case 'evaluated':
                                    statusBadge = 'bg-success';
                                    break;
                                case 'evaluating':
                                    statusBadge = 'bg-warning';
                                    break;
                                case 'error':
                                    statusBadge = 'bg-danger';
                                    break;
                                default:
                                    statusBadge = 'bg-secondary';
                            }
                            
                            solutionItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5>${solution.language} 솔루션</h5>
                                        <div class="text-muted small">제출일: ${new Date(solution.submittedAt).toLocaleString()}</div>
                                        ${solution.score !== null ? `<div><strong>점수:</strong> ${solution.score}/100</div>` : ''}
                                    </div>
                                    <div>
                                        <span class="badge ${statusBadge}">${solution.status}</span>
                                        <button class="btn btn-sm btn-primary mt-2" onclick="viewSolution(${solution.id})">상세보기</button>
                                    </div>
                                </div>
                            `;
                            
                            solutionsList.appendChild(solutionItem);
                        });
                    }
                } else {
                    alert('솔루션 목록 가져오기 실패: ' + data.message);
                }
            } catch (error) {
                console.error('솔루션 목록 가져오기 오류:', error);
                alert('솔루션 목록을 가져오는 중 오류가 발생했습니다');
            }
        }
        
        // 솔루션 상세 보기
        async function viewSolution(solutionId) {
            try {
                const response = await fetch(`/api/solutions/${solutionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const solution = data.data;
                    
                    // 코드 에디터에 코드 표시
                    document.getElementById('language').value = solution.language;
                    updateEditorMode();
                    codeMirror.setValue(solution.code);
                    
                    // 평가 결과가 있으면 표시
                    if (solution.output && solution.status === 'evaluated') {
                        try {
                            const evaluationResult = JSON.parse(solution.output);
                            displayEvaluationResult(evaluationResult);
                            evaluationCard.classList.remove('d-none');
                            
                            // 강사 피드백이 있으면 표시
                            if (solution.feedback) {
                                document.getElementById('instructorFeedback').classList.remove('d-none');
                                document.getElementById('feedback').textContent = solution.feedback;
                            } else {
                                document.getElementById('instructorFeedback').classList.add('d-none');
                            }
                        } catch (e) {
                            console.error('평가 결과 파싱 오류:', e);
                        }
                    } else {
                        evaluationCard.classList.add('d-none');
                    }
                    
                    currentSolutionId = solution.id;
                    
                    // 스크롤을 솔루션 카드로 이동
                    solutionCard.scrollIntoView({ behavior: 'smooth' });
                    
                } else {
                    alert('솔루션 상세 정보 가져오기 실패: ' + data.message);
                }
            } catch (error) {
                console.error('솔루션 상세 정보 가져오기 오류:', error);
                alert('솔루션 상세 정보를 가져오는 중 오류가 발생했습니다');
            }
        }
    </script>
</body>
</html>