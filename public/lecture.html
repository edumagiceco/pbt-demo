<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì˜ - PBT LMS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4a5568;
        }
        
        .navbar .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .navbar .nav-link {
            color: #4a5568;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .navbar .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .navbar .logout-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .breadcrumb {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #718096;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .lecture-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
        }
        
        .lecture-header {
            margin-bottom: 2rem;
        }
        
        .lecture-title {
            font-size: 2rem;
            color: #4a5568;
            margin-bottom: 1rem;
        }
        
        .lecture-meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #718096;
        }
        
        .video-container {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 10px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        #youtube-player {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }
        
        #video-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            z-index: 10;
        }
        
        .lecture-content {
            background: #f7fafc;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .lecture-navigation {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .progress-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-weight: 500;
            color: #4a5568;
        }
        
        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .lecture-navigation {
                flex-direction: column;
            }
            
            .video-container {
                height: 250px;
            }
            
            #youtube-player {
                height: 100%;
            }
        }

        /* ê°•ì‚¬ AI ìœ„ì ¯ ìŠ¤íƒ€ì¼ */
        .instructor-ai-widget {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .widget-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            min-height: 60px;
            height: 60px;
            border-radius: 15px 15px 0 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            box-sizing: border-box;
            position: relative;
            z-index: 1001;
        }

        .widget-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .widget-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.3s ease;
            line-height: 1;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .widget-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100% - 60px);
            min-height: 0;
            overflow: hidden;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: calc(100% - 80px);
        }

        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.ai {
            background: #f7fafc;
            color: #4a5568;
            align-self: flex-start;
            border: 1px solid #e2e8f0;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            background: white;
            border-radius: 0 0 15px 15px;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            min-height: 44px;
            max-height: 88px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            outline: none;
            font-size: 0.9rem;
            resize: none;
            line-height: 1.4;
            overflow-y: auto;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-send {
            padding: 1rem 1.25rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            font-size: 0.9rem;
            min-width: 70px;
        }

        .chat-send:hover {
            background: #5a6fd8;
        }

        .chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-toggle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .ai-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }

        .typing-indicator {
            padding: 0.75rem 1rem;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            align-self: flex-start;
            max-width: 80%;
            margin-bottom: 1rem;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #cbd5e0;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .instructor-ai-widget {
                bottom: 20px;
                right: 20px;
                left: 20px;
                width: auto;
                height: 400px;
            }

            .ai-toggle-btn {
                bottom: 20px;
                right: 20px;
            }
            
            .chat-input-container {
                padding: 1rem;
                gap: 0.75rem;
            }
            
            .chat-input {
                min-height: 44px;
                max-height: 88px;
                font-size: 0.9rem;
                padding: 0.875rem 1rem;
            }
            
            .chat-send {
                padding: 0.875rem 1.25rem;
                height: 44px;
                font-size: 0.9rem;
                min-width: 70px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">ğŸ§© PBT LMS</div>
        <div class="nav-links">
            <a href="/dashboard.html" class="nav-link">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/courses.html" class="nav-link">ë‚´ ê³¼ì •</a>
            <a href="/problems.html" class="nav-link">ë¬¸ì œ í’€ì´</a>
            <a href="/discussions.html" class="nav-link">í† ë¡ </a>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="/courses.html">ë‚´ ê³¼ì •</a> > 
            <a href="#" id="course-link">JavaScript ê¸°ì´ˆ í”„ë¡œê·¸ë˜ë°</a> > 
            <span id="lecture-breadcrumb">ê°•ì˜</span>
        </div>
        
        <div class="lecture-container">
            <div class="lecture-header">
                <h1 class="lecture-title" id="lecture-title">ê°•ì˜ ì œëª©</h1>
                <div class="lecture-meta">
                    <div class="meta-item">
                        <span>ğŸ¥</span>
                        <span>ë™ì˜ìƒ ê°•ì˜</span>
                    </div>
                    <div class="meta-item">
                        <span>â±ï¸</span>
                        <span id="lecture-duration">30ë¶„</span>
                    </div>
                    <div class="meta-item">
                        <span>ğŸ‘¨â€ğŸ«</span>
                        <span>ê°•ì‚¬: <span id="instructor-name">ê¹€ê°•ì‚¬</span></span>
                    </div>
                </div>
            </div>
            
            <div class="video-container">
                <div id="youtube-player"></div>
                <div id="video-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 1.2rem;">
                    ğŸ¥ ë™ì˜ìƒì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
                </div>
            </div>
            
            <div class="lecture-content">
                <h3>ğŸ“ ê°•ì˜ ë‚´ìš©</h3>
                <div id="lecture-description">
                    ì´ ê°•ì˜ì—ì„œëŠ” JavaScriptì˜ ê¸°ë³¸ ë¬¸ë²•ê³¼ ê°œë…ì„ í•™ìŠµí•©ë‹ˆë‹¤. 
                    ë³€ìˆ˜ ì„ ì–¸, ë°ì´í„° íƒ€ì…, ì—°ì‚°ì ë“± í”„ë¡œê·¸ë˜ë°ì˜ ê¸°ì´ˆê°€ ë˜ëŠ” ë‚´ìš©ë“¤ì„ ë‹¤ë£¹ë‹ˆë‹¤.
                </div>
            </div>
            
            <div class="lecture-navigation">
                <button class="btn btn-secondary" id="prev-btn" onclick="goToPrevLecture()">
                    â† ì´ì „ ê°•ì˜
                </button>
                <button class="btn btn-primary" onclick="markAsCompleted()">
                    âœ… ì™„ë£Œ ì²˜ë¦¬
                </button>
                <button class="btn btn-secondary" id="next-btn" onclick="goToNextLecture()">
                    ë‹¤ìŒ ê°•ì˜ â†’
                </button>
            </div>
        </div>
        
        <div class="progress-section">
            <div class="progress-label">
                <span>ê°•ì˜ ì§„ë„</span>
                <span id="lecture-progress">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- ê°•ì‚¬ AI í† ê¸€ ë²„íŠ¼ -->
    <button class="ai-toggle-btn" onclick="toggleInstructorAI()" title="ê°•ì‚¬ AIì™€ ëŒ€í™”í•˜ê¸°">
        ğŸ“
    </button>

    <!-- ê°•ì‚¬ AI ìœ„ì ¯ -->
    <div class="instructor-ai-widget" id="instructorAIWidget">
        <div class="widget-header">
            <div class="widget-title">
                ğŸ“ ê°•ì‚¬ AI
                <small style="font-size: 0.8rem; opacity: 0.9;">ê°•ì˜ ë‚´ìš©ì„ ì„¤ëª…í•´ë“œë ¤ìš”</small>
            </div>
            <button class="widget-close" onclick="toggleInstructorAI()">Ã—</button>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                    ì•ˆë…•í•˜ì„¸ìš”! ê°•ì‚¬ AIì…ë‹ˆë‹¤. ğŸ“<br>
                    í˜„ì¬ ê°•ì˜ ë‚´ìš©ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!<br><br>
                    <strong>ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆëŠ” ê²ƒë“¤:</strong><br>
                    â€¢ ê°•ì˜ ê°œë… ì„¤ëª…<br>
                    â€¢ ì˜ˆì‹œì™€ ë¹„ìœ ë¥¼ í†µí•œ ì´í•´<br>
                    â€¢ í•™ìŠµ ë°©ë²• ì œì•ˆ<br>
                    â€¢ ê´€ë ¨ ë‚´ìš© ì¶”ê°€ ì„¤ëª…
                </div>
                
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span style="margin-left: 0.5rem; font-size: 0.8rem; color: #718096;">
                        **í•™ìŠµë²•**: ê°•ì‚¬ AIê°€ ë‹µë³€ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...
                    </span>
                </div>
            </div>
            
            <div class="chat-input-container">
                <textarea class="chat-input" 
                         id="chatInput" 
                         placeholder="ê°•ì˜ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”..."
                         onkeypress="handleKeyPress(event)"
                         rows="1"></textarea>
                <button class="chat-send" 
                        id="sendBtn" 
                        onclick="sendMessage()">
                    ì „ì†¡
                </button>
            </div>
        </div>
    </div>

    <script>
        // YouTube Player ê´€ë ¨ ë³€ìˆ˜
        let player;
        let videoWatchTime = 0;
        let videoDuration = 0;
        let watchStartTime = null;
        
        // YouTube IFrame API ë¡œë“œ
        function loadYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        
        // YouTube APIê°€ ì¤€ë¹„ë˜ë©´ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        function onYouTubeIframeAPIReady() {
            // ê°•ì˜ë³„ YouTube ë¹„ë””ì˜¤ ID ë§¤í•‘
            const videoIds = {
                '1': 'FkN3kYBpZ-w', // JavaScript ì†Œê°œ
                '2': 'FkN3kYBpZ-w', // ë³€ìˆ˜ì™€ ë°ì´í„° íƒ€ì… (ìƒ˜í”Œìš©ìœ¼ë¡œ ê°™ì€ ì˜ìƒ)
                '3': 'FkN3kYBpZ-w', // í•¨ìˆ˜ì™€ ìŠ¤ì½”í”„ (ìƒ˜í”Œìš©ìœ¼ë¡œ ê°™ì€ ì˜ìƒ)
                '4': 'FkN3kYBpZ-w', // ê°ì²´ì™€ ë°°ì—´ (ìƒ˜í”Œìš©ìœ¼ë¡œ ê°™ì€ ì˜ìƒ)
                '5': 'FkN3kYBpZ-w'  // DOM ì¡°ì‘ (ìƒ˜í”Œìš©ìœ¼ë¡œ ê°™ì€ ì˜ìƒ)
            };
            
            const videoId = videoIds[lectureId] || 'FkN3kYBpZ-w';
            
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'playsinline': 1,
                    'rel': 0, // ê´€ë ¨ ë™ì˜ìƒ ìˆ¨ê¹€
                    'showinfo': 0, // ë™ì˜ìƒ ì •ë³´ ìˆ¨ê¹€
                    'controls': 1, // ì»¨íŠ¸ë¡¤ í‘œì‹œ
                    'modestbranding': 1, // YouTube ë¡œê³  ìµœì†Œí™”
                    'cc_load_policy': 0, // ìë§‰ ê¸°ë³¸ ë¹„í™œì„±í™”
                    'iv_load_policy': 3, // ì£¼ì„ ë¹„í™œì„±í™”
                    'fs': 1, // ì „ì²´í™”ë©´ í—ˆìš©
                    'enablejsapi': 1, // JavaScript API í™œì„±í™”
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }
        
        // í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ
        function onPlayerReady(event) {
            console.log('YouTube Player is ready');
            
            // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
            const loadingDiv = document.getElementById('video-loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            
            // ë™ì˜ìƒ ì´ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
            videoDuration = player.getDuration();
            
            // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆìŒì„ í‘œì‹œ
            showPlayerReadyMessage();
        }
        
        // í”Œë ˆì´ì–´ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
        function onPlayerStateChange(event) {
            const currentTime = player.getCurrentTime();
            
            switch (event.data) {
                case YT.PlayerState.PLAYING:
                    console.log('Video started playing');
                    watchStartTime = Date.now();
                    startProgressTracking();
                    break;
                    
                case YT.PlayerState.PAUSED:
                    console.log('Video paused');
                    if (watchStartTime) {
                        videoWatchTime += (Date.now() - watchStartTime) / 1000;
                        watchStartTime = null;
                    }
                    stopProgressTracking();
                    break;
                    
                case YT.PlayerState.ENDED:
                    console.log('Video ended');
                    if (watchStartTime) {
                        videoWatchTime += (Date.now() - watchStartTime) / 1000;
                        watchStartTime = null;
                    }
                    onVideoCompleted();
                    break;
                    
                case YT.PlayerState.BUFFERING:
                    console.log('Video buffering');
                    break;
                    
                case YT.PlayerState.CUED:
                    console.log('Video cued');
                    break;
            }
            
            updateWatchProgress();
        }
        
        // í”Œë ˆì´ì–´ ì—ëŸ¬ ì²˜ë¦¬
        function onPlayerError(event) {
            console.error('YouTube Player Error:', event.data);
            
            const loadingDiv = document.getElementById('video-loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div style="text-align: center;">
                        âš ï¸ ë™ì˜ìƒì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>
                        <small style="opacity: 0.8;">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”</small>
                    </div>
                `;
                loadingDiv.style.display = 'flex';
            }
            
            // ì—ëŸ¬ íƒ€ì…ë³„ ì²˜ë¦¬
            const errorMessages = {
                2: 'ì˜ëª»ëœ ë§¤ê°œë³€ìˆ˜ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤',
                5: 'HTML5 í”Œë ˆì´ì–´ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
                100: 'ìš”ì²­í•œ ë™ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                101: 'ë™ì˜ìƒ ì†Œìœ ìê°€ ì„ë² ë“œë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤',
                150: 'ë™ì˜ìƒ ì†Œìœ ìê°€ ì„ë² ë“œë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'
            };
            
            const errorMessage = errorMessages[event.data] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
            console.error('YouTube Error:', errorMessage);
        }
        
        // ì§„ë„ ì¶”ì  ì‹œì‘
        let progressInterval;
        function startProgressTracking() {
            stopProgressTracking(); // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            
            progressInterval = setInterval(() => {
                if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
                    updateWatchProgress();
                }
            }, 1000); // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }
        
        // ì§„ë„ ì¶”ì  ì¤‘ì§€
        function stopProgressTracking() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
        
        // ì‹œì²­ ì§„ë„ ì—…ë°ì´íŠ¸
        function updateWatchProgress() {
            if (!player || !videoDuration) return;
            
            const currentTime = player.getCurrentTime();
            const watchPercentage = Math.min((currentTime / videoDuration) * 100, 100);
            
            // UI ì—…ë°ì´íŠ¸
            const progressElement = document.getElementById('progress-fill');
            const progressLabel = document.getElementById('lecture-progress');
            
            if (progressElement && progressLabel) {
                progressElement.style.width = watchPercentage + '%';
                progressLabel.textContent = Math.round(watchPercentage) + '%';
            }
            
            // 80% ì´ìƒ ì‹œì²­ ì‹œ ì™„ë£Œë¡œ ê°„ì£¼
            if (watchPercentage >= 80) {
                markVideoAsWatched();
            }
        }
        
        // ë™ì˜ìƒ ì‹œì²­ ì™„ë£Œ ì²˜ë¦¬
        function onVideoCompleted() {
            console.log('Video completed');
            updateWatchProgress();
            
            // ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
            setTimeout(() => {
                if (confirm('ê°•ì˜ë¥¼ ëª¨ë‘ ì‹œì²­í•˜ì…¨ìŠµë‹ˆë‹¤! ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    markAsCompleted();
                }
            }, 1000);
        }
        
        // ë™ì˜ìƒ ì‹œì²­ ì™„ë£Œ í‘œì‹œ
        let isVideoWatched = false;
        function markVideoAsWatched() {
            if (!isVideoWatched) {
                isVideoWatched = true;
                console.log('Video marked as watched (80%+ completion)');
                
                // ì„œë²„ì— ì§„ë„ ì—…ë°ì´íŠ¸ ì „ì†¡ (ì‹¤ì œ êµ¬í˜„ ì‹œ)
                // updateServerProgress(courseId, lectureId, 100);
            }
        }
        
        // í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ ë©”ì‹œì§€
        function showPlayerReadyMessage() {
            // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(102, 126, 234, 0.9);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 10000;
                font-size: 0.9rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                backdrop-filter: blur(10px);
            `;
            toast.textContent = 'ğŸ¥ ë™ì˜ìƒì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(toast);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // URLì—ì„œ ê³¼ì • IDì™€ ê°•ì˜ ID ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('courseId');
        const lectureId = urlParams.get('lectureId');
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            if (!courseId || !lectureId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                history.back();
                return;
            }
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login.html';
                return;
            }
            
            // ê°•ì˜ ì •ë³´ ë¡œë“œ
            await loadLectureDetail(courseId, lectureId);
            
            // YouTube API ë¡œë“œ
            loadYouTubeAPI();
            
            // ê°•ì‚¬ AI ì…ë ¥ì°½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                // ì…ë ¥ ì‹œ ìë™ í¬ê¸° ì¡°ì •
                chatInput.addEventListener('input', autoResize);
                
                // í¬ì»¤ìŠ¤ ì‹œ ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
                chatInput.addEventListener('focus', () => {
                    setTimeout(scrollToBottom, 100);
                });
            }
            
            // ê¸°ì¡´ ê°€ì´ë“œ í‘œì‹œ
            setTimeout(showAIGuide, 5000);
        });
        
        // ê°•ì˜ ìƒì„¸ ì •ë³´ ë¡œë“œ
        async function loadLectureDetail(courseId, lectureId) {
            try {
                // ìƒ˜í”Œ ë°ì´í„°
                const lectures = {
                    '1': { id: 1, title: 'JavaScript ì†Œê°œ', duration: 30, description: 'JavaScriptì˜ ì—­ì‚¬ì™€ ê¸°ë³¸ ê°œë…ì„ ì†Œê°œí•©ë‹ˆë‹¤.' },
                    '2': { id: 2, title: 'ë³€ìˆ˜ì™€ ë°ì´í„° íƒ€ì…', duration: 45, description: 'ë³€ìˆ˜ ì„ ì–¸ ë°©ë²•ê³¼ ë‹¤ì–‘í•œ ë°ì´í„° íƒ€ì…ì„ í•™ìŠµí•©ë‹ˆë‹¤.' },
                    '3': { id: 3, title: 'í•¨ìˆ˜ì™€ ìŠ¤ì½”í”„', duration: 60, description: 'í•¨ìˆ˜ ì •ì˜ì™€ í˜¸ì¶œ, ìŠ¤ì½”í”„ì˜ ê°œë…ì„ ì´í•´í•©ë‹ˆë‹¤.' },
                    '4': { id: 4, title: 'ê°ì²´ì™€ ë°°ì—´', duration: 50, description: 'ê°ì²´ì™€ ë°°ì—´ì˜ ìƒì„± ë° ì¡°ì‘ ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤.' },
                    '5': { id: 5, title: 'DOM ì¡°ì‘', duration: 75, description: 'DOMì„ í™œìš©í•œ ì›¹ í˜ì´ì§€ ì¡°ì‘ ë°©ë²•ì„ í•™ìŠµí•©ë‹ˆë‹¤.' }
                };
                
                const lecture = lectures[lectureId];
                if (!lecture) {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê°•ì˜ì…ë‹ˆë‹¤.');
                    history.back();
                    return;
                }
                
                // ê°•ì˜ ì •ë³´ í‘œì‹œ
                document.getElementById('lecture-title').textContent = lecture.title;
                document.getElementById('lecture-breadcrumb').textContent = lecture.title;
                document.getElementById('lecture-duration').textContent = lecture.duration + 'ë¶„';
                document.getElementById('lecture-description').textContent = lecture.description;
                document.getElementById('course-link').href = `/course-detail.html?id=${courseId}`;
                
                // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');
                
                if (lectureId === '1') {
                    prevBtn.disabled = true;
                }
                
                if (lectureId === '5') {
                    nextBtn.disabled = true;
                }
                
                // ì§„ë„ ì„¤ì • (ìƒ˜í”Œ)
                const progress = Math.random() * 100;
                document.getElementById('lecture-progress').textContent = Math.round(progress) + '%';
                document.getElementById('progress-fill').style.width = progress + '%';
                
            } catch (error) {
                console.error('ê°•ì˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ê°•ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì´ì „ ê°•ì˜ë¡œ ì´ë™
        function goToPrevLecture() {
            const prevId = parseInt(lectureId) - 1;
            if (prevId >= 1) {
                window.location.href = `/lecture.html?courseId=${courseId}&lectureId=${prevId}`;
            }
        }
        
        // ë‹¤ìŒ ê°•ì˜ë¡œ ì´ë™
        function goToNextLecture() {
            const nextId = parseInt(lectureId) + 1;
            if (nextId <= 5) {
                window.location.href = `/lecture.html?courseId=${courseId}&lectureId=${nextId}`;
            }
        }
        
        // ì™„ë£Œ ì²˜ë¦¬
        function markAsCompleted() {
            if (confirm('ì´ ê°•ì˜ë¥¼ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                alert('ê°•ì˜ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                // ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì™„ë£Œ ìƒíƒœë¥¼ ì „ì†¡
                // ë‹¤ìŒ ê°•ì˜ë¡œ ìë™ ì´ë™
                const nextId = parseInt(lectureId) + 1;
                if (nextId <= 5) {
                    setTimeout(() => {
                        window.location.href = `/lecture.html?courseId=${courseId}&lectureId=${nextId}`;
                    }, 1000);
                } else {
                    setTimeout(() => {
                        window.location.href = `/course-detail.html?id=${courseId}`;
                    }, 1000);
                }
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = '/';
            }
        }

        // ê°•ì‚¬ AI ê´€ë ¨ ë³€ìˆ˜
        let currentSessionId = null;
        let isAIResponding = false;

        // ê°•ì‚¬ AI ìœ„ì ¯ í† ê¸€
        function toggleInstructorAI() {
            const widget = document.getElementById('instructorAIWidget');
            const toggleBtn = document.querySelector('.ai-toggle-btn');
            
            if (!widget) return;

            if (widget.style.display === 'flex') {
                widget.style.display = 'none';
                toggleBtn.style.display = 'block';
            } else {
                widget.style.display = 'flex';
                toggleBtn.style.display = 'none';
                setTimeout(() => {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) chatInput.focus();
                }, 100);
            }
        }

        // ì—”í„° í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey && !isAIResponding) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ì…ë ¥ì°½ ìë™ í¬ê¸° ì¡°ì •
        function autoResize() {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            // ë†’ì´ ìë™ ì¡°ì •
            input.style.height = 'auto';
            const newHeight = Math.min(Math.max(input.scrollHeight, 44), 88);
            input.style.height = newHeight + 'px';
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isAIResponding) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage(message, 'user');
            input.value = '';
            
            // ì…ë ¥ì°½ í¬ê¸° ë¦¬ì…‹
            input.style.height = '44px';
            
            // UI ìƒíƒœ ë³€ê²½
            const sendBtn = document.getElementById('sendBtn');
            const typingIndicator = document.getElementById('typingIndicator');
            
            isAIResponding = true;
            sendBtn.disabled = true;
            input.disabled = true;
            typingIndicator.style.display = 'block';
            
            // ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ ìŠ¤í¬ë¡¤
            scrollToBottom();
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/instructor-ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        lectureId: courseId,
                        materialId: null, // í˜„ì¬ëŠ” null, ì¶”í›„ ê°•ì˜ ìë£Œ ID ì—°ê²°
                        sessionId: currentSessionId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // ì„¸ì…˜ ID ì €ì¥
                    currentSessionId = data.data.sessionId;
                    
                    // AI ì‘ë‹µ ì¶”ê°€
                    addMessage(data.data.response, 'ai');
                } else {
                    addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
                }
            } catch (error) {
                console.error('ê°•ì‚¬ AI ì˜¤ë¥˜:', error);
                addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ai');
            } finally {
                // UI ìƒíƒœ ë³µì›
                isAIResponding = false;
                sendBtn.disabled = false;
                input.disabled = false;
                
                // typing indicator ìˆ¨ê¹€
                typingIndicator.style.display = 'none';
                
                // í¬ì»¤ìŠ¤ ë³µì›
                input.focus();
                scrollToBottom();
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(message, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            // ë©”ì‹œì§€ ë‚´ìš© í¬ë§·íŒ… (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
            const formattedMessage = message.replace(/\n/g, '<br>');
            messageDiv.innerHTML = formattedMessage;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // ì±„íŒ… ì˜ì—­ ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ê°•ì‚¬ AI ì‚¬ìš© ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
        function showAIGuide() {
            const guideMessages = [
                "ğŸ’¡ **íŒ**: 'ì´ ê°œë…ì„ ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”'ë¼ê³  ë¬¼ì–´ë³´ì„¸ìš”!",
                "ğŸ” **ì˜ˆì‹œ**: 'ì‹¤ì œ ì˜ˆì‹œë¥¼ ë“¤ì–´ ì„¤ëª…í•´ì£¼ì„¸ìš”'",
                "ğŸ“š **í•™ìŠµë²•**: 'ì´ ë‚´ìš©ì„ íš¨ê³¼ì ìœ¼ë¡œ í•™ìŠµí•˜ëŠ” ë°©ë²•ì€?'"
            ];
            
            const randomGuide = guideMessages[Math.floor(Math.random() * guideMessages.length)];
            
            setTimeout(() => {
                addMessage(randomGuide, 'ai');
            }, 3000);
        }
    </script>
</body>
</html>